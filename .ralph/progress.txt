## Iteration 1 - task-001: CLI argument parsing

### Completed
- Set up Cargo project with Rust 2024 edition
- Implemented CLI argument parsing with clap derive macros
- Supports: add, remove, list subcommands and --clean flag
- Parses ecosystem:package@version syntax correctly
- Handles scoped packages (@org/pkg), Go module paths, version prefixes (v)
- Normalizes package names to lowercase and strips v prefix from versions
- 12 unit tests pass

### Key decisions
- Used clap derive API for declarative argument parsing
- DepSpec struct with FromStr for parsing dependency specifications
- Ecosystem enum with FromStr supporting aliases (npm->node, cargo->rust, etc.)
- Handle --clean vs subcommand conflict in main() rather than clap attribute

### Files changed
- Cargo.toml (new)
- src/main.rs (new)
- src/cli.rs (new)
- README.md (new)
- .ralph/prd.json (updated task-001 passes: true)

### Next
- task-002: Implement cache and .deps directory structure

## Iteration 2 - task-002 & task-005: Cache and .deps directory structure

### Completed
- Implemented cache module for ~/.cache/dotdeps/<ecosystem>/<package>/<version>/
- Implemented deps module for .deps/<ecosystem>/<package> symlinks
- Created symlinks with absolute paths to cache
- Windows detection with copy_dir_recursive fallback
- List command with broken symlink detection
- Remove command (removes symlink, preserves cache)
- Clean command (removes entire .deps/)
- Handles nested paths: scoped npm (@org/pkg), Go modules (github.com/org/repo/v2)
- XDG_CACHE_HOME environment variable respected
- 21 unit tests pass

### Key decisions
- Used `dirs` crate for cross-platform home directory detection
- Symlinks use absolute paths for reliability
- Cache existence checked via .git directory presence
- Empty ecosystem directories cleaned up on remove
- path and target fields in DepEntry kept for future debugging use

### Files changed
- Cargo.toml (added dirs dependency)
- src/main.rs (wired up cache and deps modules)
- src/cache.rs (new)
- src/deps.rs (new)
- README.md (updated status)
- .ralph/prd.json (task-002 and task-005 passes: true)

### Verified behavior
- `dotdeps add python:requests@2.31.0` creates symlink at .deps/python/requests
- `dotdeps add node:@org/pkg@4.17.21` handles scoped packages
- `dotdeps add go:github.com/org/repo/v2@1.0.0` handles Go module paths
- `dotdeps list` shows ecosystem:package@version format
- `dotdeps list` detects broken symlinks (cache evicted)
- `dotdeps remove python:requests` removes symlink, preserves cache
- `dotdeps --clean` removes entire .deps/ directory

### Next
- task-003: Implement git cloning with tag resolution

## Iteration 3 - task-003: Git cloning with tag resolution

### Completed
- Created git module with shallow clone functionality (--depth 1)
- Implemented tag resolution order: v{version} -> {version} -> default branch
- Added warning message when falling back to default branch
- Implemented cleanup of partial clone directories on failure
- Added Go ecosystem repo URL detection from module path
  - github.com/* -> https://github.com/*.git
  - golang.org/x/* -> https://go.googlesource.com/*.git
- 22 unit tests pass

### Key decisions
- Used std::process::Command for git operations (no external crate needed)
- CloneResult struct returns whether default branch was used and which ref was cloned
- Go modules get special treatment since package path IS the repo URL
- Other ecosystems return clear error message directing to config.json override
- Parent directories left in cache on failure (empty, no harm)

### Files changed
- src/git.rs (new)
- src/main.rs (wired in git module, added detect_repo_url function)
- README.md (updated status)
- .ralph/prd.json (task-003 passes: true)

### Verified behavior
- `dotdeps add go:github.com/gin-gonic/gin@1.9.1` clones at v1.9.1 tag
- `dotdeps add go:golang.org/x/sync@0.6.0` clones from go.googlesource.com
- Cache hit on second add of same package
- Nonexistent tag falls back to default branch with warning
- Clone failure cleans up partial directory
- Non-Go ecosystems show clear error about missing repo detection

### Next
- task-004: Implement Python ecosystem lockfile parsing and PyPI repo detection

## Iteration 4 - task-004: Python ecosystem lockfile parsing and PyPI repo detection

### Completed
- Created python module with lockfile and pypi submodules
- Implemented lockfile parsing for:
  - poetry.lock (TOML [[package]] array)
  - uv.lock (TOML [[package]] array)
  - requirements.txt (exact pins: package==version)
  - pyproject.toml (tool.poetry.dependencies and project.dependencies PEP 621)
- Implemented PyPI repo URL detection via JSON API
  - Checks project_urls for Source, Repository, GitHub keys
  - Falls back to home_page if it looks like a git repo
- Integrated lockfile lookup into add command when version is omitted
- Python package names normalized (case-insensitive, - and _ equivalent)
- 35 unit tests pass

### Key decisions
- Used toml crate for TOML parsing with serde deserialization
- Used ureq for HTTP requests (minimal dependency footprint)
- Used serde_json for PyPI JSON API parsing
- Lockfile search walks up directory tree to find nearest lockfile
- Lockfile priority: poetry.lock > uv.lock > requirements.txt > pyproject.toml
- requirements.txt only returns exact versions (== pins) for reliability
- pyproject.toml supports both Poetry-style and PEP 621-style dependencies
- Go repo detection refactored to use regex-like version suffix stripping

### Files changed
- Cargo.toml (added serde, serde_json, toml, ureq dependencies)
- src/main.rs (added python module, lookup_version function, updated detect_repo_url)
- src/python.rs (new - module root)
- src/python/lockfile.rs (new - lockfile parsing)
- src/python/pypi.rs (new - PyPI API integration)
- README.md (updated status and examples)
- .ralph/prd.json (task-004 passes: true)

### Verified behavior
- `dotdeps add python:requests` reads version from poetry.lock/uv.lock/etc.
- `dotdeps add python:flask` fetches from PyPI, clones repo at correct tag
- `dotdeps add python:typing-extensions` normalizes package name with hyphens
- `dotdeps add python:httpx@0.25.0` explicit version overrides lockfile
- Version not in lockfile shows helpful error message
- No lockfile found shows clear error message
- Cache hit reuses cached clone
- `dotdeps list` shows correct versions

### Next
- Implement Node.js ecosystem (pnpm-lock.yaml, yarn.lock, package-lock.json, npm registry)

## Iteration 5 - task-006: Node.js ecosystem lockfile parsing and npm registry detection

### Completed
- Created node module with lockfile and npm submodules
- Implemented lockfile parsing for:
  - pnpm-lock.yaml (YAML, lockfileVersion 9.0)
  - yarn.lock (custom format, not YAML - line-based parser)
  - package-lock.json (JSON, lockfileVersion 1, 2, and 3)
- Implemented npm registry repo URL detection
  - Handles repository field as string or object
  - Handles various URL formats: git+https, git://, git@, github: shorthand
  - Falls back to homepage if it looks like a git repo
- Scoped packages (@org/pkg) handled correctly in all parsers
- Package names normalized to lowercase for cache consistency
- 60 unit tests pass

### Key decisions
- Used serde_yml for YAML parsing
- yarn.lock is NOT valid YAML - implemented custom line-based parser
- Package version extracted from lockfile key (name@version) rather than nested structure
- npm repository URL normalization handles many edge cases (git+, ssh, shorthand)
- is_known_git_host() checks for known hosts before adding .git suffix

### Files changed
- Cargo.toml (added serde_yml dependency)
- src/main.rs (added node module, wired lockfile and repo detection)
- src/node.rs (new - module root)
- src/node/lockfile.rs (new - lockfile parsing)
- src/node/npm.rs (new - npm registry integration)
- README.md (updated status and examples)
- .ralph/prd.json (task-006 passes: true)

### Verified behavior
- `dotdeps add node:lodash` reads version from pnpm-lock.yaml/yarn.lock/package-lock.json
- `dotdeps add node:lodash@4.17.21` explicit version works
- `dotdeps add node:@types/node` scoped packages work correctly
- `dotdeps add node:express@4.18.0` fetches from npm, clones repo at correct tag
- Version not in lockfile shows helpful error message
- No lockfile found shows clear error message
- Cache hit reuses cached clone
- `dotdeps list` shows correct versions for all packages
- `dotdeps remove node:express` removes symlink correctly

### Next
- Implement Rust ecosystem (Cargo.lock parsing, crates.io repo detection)
